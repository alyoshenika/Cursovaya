<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ ‚Äî –í–∏–∫—Ç–æ—Ä–æ–≤–∞ –ê–ª—ë–Ω–∞ –í—è—á–µ—Å–ª–∞–≤–æ–≤–Ω–∞</title>

<!-- Chart.js and SheetJS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0d0d0d;
    --card:#151515;
    --panel:#1a0026;
    --accent:#a64bff;
    --accent-2:#6b00d9;
    --text:#ffefff;
    --muted:#b6a6d9;
    --muted-2:#8b78a8;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#0b0222);color:var(--text);min-height:100vh}

  /* header */
  header{background:linear-gradient(90deg,#130020,#2a0036);padding:28px;text-align:center;border-bottom:3px solid rgba(166,75,255,0.12);box-shadow:0 8px 40px rgba(107,0,217,0.12)}
  header h1{margin:0;font-size:26px;letter-spacing:1.6px;color:var(--text);text-shadow:0 0 8px rgba(166,75,255,0.18)}
  header p{margin:6px 0 0;color:var(--muted);font-size:14px}

  /* sidebar (burger hover to expand) */
  .sidebar{
    position:fixed;left:0;top:0;height:100%;width:60px;overflow:hidden;
    background:linear-gradient(180deg,var(--panel),#2b002f);border-right:2px solid rgba(107,0,217,0.25);
    transition:width .28s ease;z-index:1000;padding-top:20px;
  }
  .sidebar:hover{width:240px}
  .burger{width:44px;margin:10px auto 6px;cursor:default}
  .burger .bar{height:5px;background:var(--muted);margin:6px 0;border-radius:4px;box-shadow:0 0 10px rgba(166,75,255,0.08)}
  .menu{margin-top:18px;padding-left:8px}
  .menu button{display:block;width:calc(100% - 16px);margin:8px;padding:12px;border-radius:10px;border:none;background:transparent;color:var(--muted);text-align:left;cursor:pointer;font-weight:600;transition:background .15s, color .15s, transform .12s;opacity:0;transform:translateX(-6px)}
  .sidebar:hover .menu button{opacity:1;transform:none}
  .menu button:hover{background:linear-gradient(90deg,rgba(166,75,255,0.12),rgba(107,0,217,0.14));color:var(--text)}
  .menu button.active{background:linear-gradient(90deg,rgba(166,75,255,0.20),rgba(107,0,217,0.22));color:var(--text)}

  /* content moves when sidebar hover */
  main{transition:margin-left .28s ease;margin-left:60px;padding:26px 28px}
  .sidebar:hover ~ main{margin-left:240px}

  /* cards */
  .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:18px;box-shadow:0 10px 30px rgba(20,5,30,0.5);border:1px solid rgba(166,75,255,0.03)}
  h2{margin:0 0 12px 0;color:var(--text)}
  .muted{color:var(--muted);font-size:13px}

  /* form */
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input[type=text], input[type=number], select{background:#110014;border:1px solid rgba(166,75,255,0.06);color:var(--text);padding:10px;border-radius:8px;min-width:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;cursor:pointer}

  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;color:var(--text)}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{background:linear-gradient(90deg,#2b0033,#1b0030);font-weight:700;color:var(--muted)}
  tbody tr:hover td{background:linear-gradient(90deg,rgba(166,75,255,0.03),transparent)}

  /* responsive */
  @media(max-width:900px){
    .sidebar{position:fixed;left:0;top:0;width:60px}
    .sidebar:hover{width:220px}
    main{padding:18px}
  }

  /* small helpers */
  .small{font-size:13px;color:var(--muted)}
  .center{display:flex;align-items:center;gap:8px}
  canvas{background:transparent;border-radius:8px}
</style>
</head>
<body>

<header>
  <h1>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</h1>
  <p>–ê–≤—Ç–æ—Ä: –í–∏–∫—Ç–æ—Ä–æ–≤–∞ –ê–ª—ë–Ω–∞ –í—è—á–µ—Å–ª–∞–≤–æ–≤–Ω–∞</p>
</header>

<!-- SIDEBAR -->
<aside class="sidebar" aria-hidden="false">
  <div class="burger" title="–ú–µ–Ω—é (–Ω–∞–≤–µ–¥–∏—Ç–µ –º—ã—à—å)">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>

  <nav class="menu" role="navigation" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
    <button data-tab="upload" class="active">üì• –ó–∞–≥—Ä—É–∑–∫–∞</button>
    <button data-tab="editor">‚úèÔ∏è –°–æ–∑–¥–∞—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button data-tab="stats_table">üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞)</button>
    <button data-tab="stats_chart">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫–∏)</button>
    <button data-tab="help">‚ùì –ü–æ–º–æ—â—å</button>
    <button data-tab="about">‚ÑπÔ∏è –û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
  </nav>
</aside>

<!-- MAIN -->
<main>
  <!-- UPLOAD -->
  <section id="upload" class="card" aria-labelledby="uploadTitle">
    <h2 id="uploadTitle">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</h2>
    <div class="small">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: .csv, .txt, .xlsx (UTF-8). –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –≤ –æ–±–ª–∞—Å—Ç—å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É.</div>

    <div style="margin-top:12px" class="card" id="drop_area" role="region" aria-label="–ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏" >
      <div class="center" style="justify-content:space-between">
        <div>
          <strong>–ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏</strong>
          <div class="small">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª¬ª.</div>
        </div>
        <div class="controls">
          <input id="file_input" type="file" accept=".csv,.txt,.xlsx" style="display:none">
          <button class="primary" id="choose_file">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
          <button class="ghost" id="clear_data">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
      </div>
      <div id="file_name" class="small" style="margin-top:10px;color:var(--muted)"></div>
    </div>

    <div id="table_preview" style="margin-top:12px"></div>
  </section>

  <!-- EDITOR -->
  <section id="editor" class="card" style="display:none">
    <h2>–°–æ–∑–¥–∞—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª</h2>
    <div class="small">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤—Ä—É—á–Ω—É—é, –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</div>

    <div style="margin-top:12px" class="card">
      <div class="row">
        <input id="input_group" type="text" placeholder="–ì—Ä—É–ø–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –ë–ë-309)">
        <input id="input_last" type="text" placeholder="–§–∞–º–∏–ª–∏—è">
        <input id="input_first" type="text" placeholder="–ò–º—è">
        <input id="input_patron" type="text" placeholder="–û—Ç—á–µ—Å—Ç–≤–æ">
      </div>

      <div id="subjects_inputs" style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>

      <div style="margin-top:12px" class="controls">
        <button class="primary" id="add_student">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="ghost" id="update_student">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π</button>
        <button class="ghost" id="delete_student">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ</button>
        <button class="ghost" id="save_csv">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å .csv</button>
        <button class="ghost" id="export_xlsx">–°–∫–∞—á–∞—Ç—å .xlsx</button>
      </div>
    </div>

    <div id="edit_table_wrapper" style="margin-top:12px"></div>
  </section>

  <!-- STATS TABLE -->
  <section id="stats_table" class="card" style="display:none">
    <h2>–¢–∞–±–ª–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏/–∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:end">
      <div style="min-width:160px">
        <label class="small">–ì—Ä—É–ø–ø–∞</label>
        <select id="stats_group"></select>
      </div>
      <div style="min-width:160px">
        <label class="small">–ü—Ä–µ–¥–º–µ—Ç</label>
        <select id="stats_subject"></select>
      </div>
      <div>
        <button class="ghost" id="recalc_stats">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>

    <div id="stats_table_wrapper" style="margin-top:12px"></div>
  </section>

 <!-- STATS CHART -->
<section id="stats_chart" class="card" style="display:none">
  <h2>–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
    <!-- –ù–æ–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="card"><canvas id="chart_canvas_5" height="180"></canvas></div>
    <div class="card"><canvas id="chart_canvas_6" height="180"></canvas></div>
    <div class="card"><canvas id="chart_canvas_7" height="180"></canvas></div>
    <div class="card"><canvas id="chart_canvas_8" height="180"></canvas></div>
  </div>
</section>

  <!-- HELP -->
  <section id="help" class="card" style="display:none">
    <h2>–ü–æ–º–æ—â—å</h2>
    <div>
      <p>–ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:</p>
      <ul>
        <li><b>–ó–∞–≥—Ä—É–∑–∫–∞</b> ‚Äî –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ .csv/.txt/.xlsx. –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏: <code>Group,LastName,FirstName,Patronymic,–ò–í–¢–°,–¶–û–°,–¢–≠–°,–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è,–§–∏–ª–æ—Å–æ—Ñ–∏—è,–ê–Ω—Ç–µ–Ω–Ω—ã,–§–∏–∑—Ä–∞,–ò–¢,–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</code> –ª–∏–±–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ.</li>
        <li><b>–°–æ–∑–¥–∞—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</b> ‚Äî –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤—Ä—É—á–Ω—É—é, –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —É–¥–∞–ª—è–π—Ç–µ, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ.</li>
        <li><b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞)</b> ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ –≥—Ä—É–ø–ø—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å—Ä–µ–¥–Ω–µ–µ, –º–µ–¥–∏–∞–Ω–∞, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.</li>
        <li><b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫–∏)</b> ‚Äî –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: –ª–∏–Ω–∏—è —Å—Ä–µ–¥–Ω–∏—Ö, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ —Ç.–¥.</li>
      </ul>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="card" style="display:none">
    <h2>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ / –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</h2>
    <div style="display:flex;gap:12px;align-items:center">
       <img src="author.jpg" alt="author" style="border-radius:120px;width:500px">
      <div>
      <p><strong>–í–∏–∫—Ç–æ—Ä–æ–≤–∞ –ê–ª—ë–Ω–∞ –í—è—á–µ—Å–ª–∞–≤–æ–≤–Ω–∞</strong></p>
<a href="https://e.mail.ru/compose/?to=alyonaviktorova2005@mail.ru" target="_blank" style="color:#ff99ff">
  alyonaviktorova2005@mail.ru
</a>
</a>
<p>–£—á–µ–±–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ: –°–∏–±–∏—Ä—Å–∫–∏–π –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç —Ç–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∏.</p>
<p>–ü—Ä–æ—Ñ–∏–ª—å: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ç–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º(–ø–æ –æ—Ç—Ä–∞—Å–ª–∏ –∏–ª–∏ –≤ —Å—Ñ–µ—Ä–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)</p>
<p>–ö–∞—Ñ–µ–¥—Ä–∞: –ö–∞—Ñ–µ–¥—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π(–ë–ò–¢)</p>
<p>–ò–Ω—Å—Ç–∏—Ç—É—Ç: –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
<p>–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: –±–∞–∫–∞–ª–∞–≤—Ä</p>
<p>–§–æ—Ä–º–∞ –æ–±—É—á–µ–Ω–∏—è: –û—á–Ω–∞—è</p>
<p>–°—Ä–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: 4–≥.</p>
      </div>
    </div>
  </section>

</main>

<script>
/* ========== –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ========== */
let data = []; // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤: {Group, LastName, FirstName, Patronymic, –ò–í–¢–°:5, ...}
const subjects = ['–ò–í–¢–°','–¶–û–°','–¢–≠–°','–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è','–§–∏–ª–æ—Å–æ—Ñ–∏—è','–ê–Ω—Ç–µ–Ω–Ω—ã','–§–∏–∑—Ä–∞','–ò–¢','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏'];
let selectedIndex = null;
let chartInstances = [];

/* ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---------- */
function q(sel){ return document.querySelector(sel); }
function qa(sel){ return Array.from(document.querySelectorAll(sel)); }

/* CSV –ø–∞—Ä—Å–µ—Ä (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞–≤—ã—á–µ–∫ –∏ BOM) */
function parseCSV(text, sep=','){
  // remove BOM if present
  if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const lines = text.split(/\r\n|\n|\r/).filter(l=>l.trim().length>0);
  if(lines.length===0) return [];
  const headers = splitCSVLine(lines[0], sep).map(h=>h.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const parts = splitCSVLine(lines[i], sep);
    const obj = {};
    headers.forEach((h, idx) => { obj[h]= parts[idx] !== undefined ? parts[idx].trim() : ''; });
    rows.push(obj);
  }
  return rows;
}
function splitCSVLine(line, sep=','){
  const re = new RegExp(`\\s*(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^${sep}]+))\\s*(?:${sep}|$)`, 'g');
  const out = [];
  let match;
  while((match = re.exec(line)) !== null){
    let val = match[1]!==undefined ? match[1].replace(/""/g,'"') : (match[2]||'');
    out.push(val);
  }
  return out;
}

/* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –≤ localStorage */
function saveToLocal(){ try{ localStorage.setItem('gradebook_vv', JSON.stringify(data)); }catch(e){} }
function loadFromLocal(){ try{ const raw = localStorage.getItem('gradebook_vv'); if(!raw) return false; data = JSON.parse(raw); return true; }catch(e){return false;} }

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –≥—Ä—É–ø–ø/–ø—Ä–µ–¥–º–µ—Ç–æ–≤ */
function refreshSelectors(){
  const groups = Array.from(new Set(data.map(r=>r.Group).filter(Boolean)));
  const sg = q('#stats_group'); if(sg){ const old = sg.value; sg.innerHTML=''; const o=document.createElement('option'); o.value='ALL'; o.textContent='ALL'; sg.appendChild(o); groups.forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.textContent=g; sg.appendChild(opt); }); if(old) sg.value=old; }
  const ss = q('#stats_subject'); if(ss){ const old = ss.value; ss.innerHTML=''; const o=document.createElement('option'); o.value='ALL'; o.textContent='ALL'; ss.appendChild(o); subjects.forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; ss.appendChild(opt); }); if(old) ss.value=old; }
}

/* ========== –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶ ========== */
function renderTable(containerId, editable=false){
  const container = q('#'+containerId);
  if(!container) return;
  if(data.length===0){ container.innerHTML = '<div class="small">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å.</div>'; return; }
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  ['#','–ì—Ä—É–ø–ø–∞','–§–∞–º–∏–ª–∏—è','–ò–º—è','–û—Ç—á–µ—Å—Ç–≤–æ', ...subjects].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; headRow.appendChild(th); });
  thead.appendChild(headRow); table.appendChild(thead);

  const tbody = document.createElement('tbody');
  data.forEach((row, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    tr.addEventListener('click', ()=> {
      selectRow(idx);
      // –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø—Ä–µ–≤—å—é ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
      activateTab('editor');
    });
    const cols = [idx+1, row.Group||'', row.LastName||'', row.FirstName||'', row.Patronymic||'', ...subjects.map(s=> row[s]===undefined ? '' : row[s])];
    cols.forEach(c=>{ const td=document.createElement('td'); td.textContent = c; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.innerHTML=''; container.appendChild(table);
}

/* –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ */
function renderEditTable(){
  const wrap = q('#edit_table_wrapper');
  if(!wrap) return;
  if(data.length===0){ wrap.innerHTML = '<div class="small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  ['#','–ì—Ä—É–ø–ø–∞','–§–∞–º–∏–ª–∏—è','–ò–º—è','–û—Ç—á–µ—Å—Ç–≤–æ', ...subjects, '–î–µ–π—Å—Ç–≤–∏—è'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; headRow.appendChild(th); });
  thead.appendChild(headRow); table.appendChild(thead);

  const tbody = document.createElement('tbody');
  data.forEach((row, idx)=>{
    const tr = document.createElement('tr');
    const cols = [idx+1, row.Group||'', row.LastName||'', row.FirstName||'', row.Patronymic||'', ...subjects.map(s=> row[s]===undefined ? '' : row[s])];
    cols.forEach(c=>{ const td=document.createElement('td'); td.textContent = c; tr.appendChild(td); });
    const tdAct = document.createElement('td');
    const selBtn = document.createElement('button'); selBtn.className='ghost'; selBtn.textContent='–í—ã–±—Ä–∞—Ç—å'; selBtn.addEventListener('click', ()=> selectRow(idx));
    tdAct.appendChild(selBtn);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.innerHTML=''; wrap.appendChild(table);
}

/* ========== –†–ê–ë–û–¢–ê –° –í–´–ë–û–†–ö–û–ô ========== */
function selectRow(i){
  selectedIndex = i;
  const r = data[i];
  q('#input_group').value = r.Group||'';
  q('#input_last').value = r.LastName||'';
  q('#input_first').value = r.FirstName||'';
  q('#input_patron').value = r.Patronymic||'';
  subjects.forEach((s, idx)=>{ const el = q('#subj_'+idx); if(el) el.value = r[s]===undefined ? '' : r[s]; });
}

/* ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï / –£–ü–†–ê–í–õ–ï–ù–ò–ï ========== */
function renderEditSubjects(){
  const wrap = q('#subjects_inputs'); if(!wrap) return;
  wrap.innerHTML='';
  subjects.forEach((s, idx)=>{
    const div = document.createElement('div'); div.style.display='flex'; div.style.flexDirection='column';
    const label = document.createElement('label'); label.textContent = s; label.style.marginBottom='6px'; label.className='small';
    const input = document.createElement('input'); input.type='number'; input.id = 'subj_'+idx; input.min=2; input.max=5; input.placeholder='–æ—Ü–µ–Ω–∫–∞';
    div.appendChild(label); div.appendChild(input); wrap.appendChild(div);
  });
}

function addStudent(){
  const obj = {
    Group: q('#input_group').value.trim() || '–ë–ë-309',
    LastName: q('#input_last').value.trim() || '',
    FirstName: q('#input_first').value.trim() || '',
    Patronymic: q('#input_patron').value.trim() || ''
  };
  subjects.forEach((s, idx)=>{ const v = q('#subj_'+idx).value; obj[s] = v ? Number(v) : ''; });
  if(!obj.LastName){ alert('–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é'); return; }
  data.push(obj); saveToLocal(); refreshAll();
}

function updateStudent(){
  if(selectedIndex===null){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É'); return; }
  const obj = data[selectedIndex];
  obj.Group = q('#input_group').value.trim() || obj.Group;
  obj.LastName = q('#input_last').value.trim() || obj.LastName;
  obj.FirstName = q('#input_first').value.trim() || obj.FirstName;
  obj.Patronymic = q('#input_patron').value.trim() || obj.Patronymic;
  subjects.forEach((s, idx)=>{ const v = q('#subj_'+idx).value; obj[s] = v ? Number(v) : ''; });
  data[selectedIndex] = obj; saveToLocal(); refreshAll();
}

function deleteStudent(){
  if(selectedIndex===null){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É'); return; }
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞?')) return;
  data.splice(selectedIndex,1); selectedIndex=null; saveToLocal(); refreshAll();
}

/* ========== –≠–ö–°–ü–û–†–¢ ========== */
function saveCSV(){
  if(data.length===0){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); return; }
  const headers = ['Group','LastName','FirstName','Patronymic', ...subjects];
  const rows = data.map(r => headers.map(h => r[h]===undefined ? '' : r[h]));
  const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))].join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gradebook.csv'; document.body.appendChild(a); a.click(); a.remove();
}

function exportXLSX(){
  if(data.length===0){ alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞'); return; }
  const header = ['Group','LastName','FirstName','Patronymic', ...subjects];
  const aoa = data.map(r=> {
    const row = {};
    header.forEach(h => row[h] = r[h]===undefined ? '' : r[h]);
    return row;
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(aoa, {header});
  XLSX.utils.book_append_sheet(wb, ws, 'Grades');
  XLSX.writeFile(wb, 'gradebook.xlsx');
}

/* ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ========== */
function computeStats(filterGroup='ALL', filterSubject='ALL'){
  const long = [];
  data.forEach(r => subjects.forEach(s => {
    const g = r[s]; if(g!==undefined && g!=='') long.push({Group: r.Group||'', Subject: s, Grade: Number(g)});
  }));
  let arr = long;
  if(filterGroup!=='ALL') arr = arr.filter(x => x.Group === filterGroup);
  if(filterSubject!=='ALL') arr = arr.filter(x => x.Subject === filterSubject);
  if(arr.length===0) return [];
  const bySG = {};
  arr.forEach(x => { const key = x.Subject + '||' + x.Group; if(!bySG[key]) bySG[key]=[]; bySG[key].push(x.Grade); });
  const rows = [];
  for(const key in bySG){
    const [subject, group] = key.split('||');
    const grades = bySG[key].slice().sort((a,b)=>a-b);
    const mean = (grades.reduce((a,b)=>a+b,0)/grades.length).toFixed(2);
    const medianRaw = grades.length%2===1 ? grades[(grades.length-1)/2] : ((grades[grades.length/2-1] + grades[grades.length/2])/2);
    const median = Number(medianRaw).toFixed(2);
    const counts = {}; grades.forEach(g=> counts[g] = (counts[g]||0)+1);
    for(const grade in counts){
      rows.push({Subject:subject, Group:group, Mean:mean, Median:median, Grade:grade, Count:counts[grade], Percent: ((counts[grade]/grades.length)*100).toFixed(2), Total:grades.length});
    }
  }
  return rows;
}

function renderStatsTable(){
  const groupSel = q('#stats_group'); const subjSel = q('#stats_subject');
  const rows = computeStats(groupSel.value||'ALL', subjSel.value||'ALL');
  const wrap = q('#stats_table_wrapper');
  if(!rows || rows.length===0){ wrap.innerHTML = '<div class="small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>'; return; }
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const htr = document.createElement('tr');
  ['–ü—Ä–µ–¥–º–µ—Ç','–ì—Ä—É–ø–ø–∞','–°—Ä–µ–¥–Ω–µ–µ','–ú–µ–¥–∏–∞–Ω–∞','–û—Ü–µ–Ω–∫–∞','–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ','–ü—Ä–æ—Ü–µ–Ω—Ç','–í—Å–µ–≥–æ'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; htr.appendChild(th); });
  thead.appendChild(htr); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    ['Subject','Group','Mean','Median','Grade','Count','Percent','Total'].forEach(k=>{ const td=document.createElement('td'); td.textContent = r[k]; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); wrap.innerHTML=''; wrap.appendChild(table);
}

/* ========== –ì–†–ê–§–ò–ö–ò ========== */
function clearCharts(){ chartInstances.forEach(c=>{ try{ c.destroy(); }catch(e){} }); chartInstances=[]; }
function renderCharts(){
  clearCharts();

  // ---------- NEW CHARTS ONLY ----------
  const labels = subjects;

  // 5. –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ
  const groupLabels = Array.from(new Set(data.map(r=>r.Group)));
  const groupCounts = groupLabels.map(g => {
    const arr = data.filter(r=>r.Group===g);
    const counts = arr.map(r => subjects.map(s=> r[s]!==undefined ? Number(r[s]) : 0)).flat();
    return counts.reduce((acc,v)=>{
      acc[v] = (acc[v]||0)+1; return acc;
    }, {});
  });
  const gradeSet = ['2','3','4','5'];
  const datasets5 = gradeSet.map((g,idx)=>({label:g, data: groupCounts.map(gc=>gc[g]||0), backgroundColor:`rgba(${50+idx*50},${50+idx*30},${200-idx*30},0.7)`}));
  chartInstances.push(new Chart(q('#chart_canvas_5').getContext('2d'), { type:'bar', data:{labels:groupLabels, datasets:datasets5}, options:{responsive:true, plugins:{legend:{position:'top'}}} }));

  // 6. –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∞–ª–ª–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º
  const meanPerSubject = labels.map(s => {
    const arr = data.map(r=> r[s]!==undefined && r[s]!=='' ? Number(r[s]) : 0).filter(v=>v>0);
    return arr.length ? +(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : 0;
  });
  chartInstances.push(new Chart(q('#chart_canvas_6').getContext('2d'), { type:'line', data:{labels, datasets:[{label:'–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º', data:meanPerSubject, borderColor:'rgba(0,200,150,0.9)', backgroundColor:'rgba(0,200,150,0.12)', tension:0.3, fill:true} ]}, options:{responsive:true, plugins:{legend:{display:true}}} }));

  // 7. Radar-–≥—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º –¥–ª—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã
  const radarData = labels.map(s=>{
    const counts = {'2':0,'3':0,'4':0,'5':0};
    data.forEach(r=>{ if(r[s]!==undefined && r[s]!==''){ counts[r[s]]++; } });
    return counts['5']+counts['4']; // —Å—É–º–º–∞—Ä–Ω–æ —Ö–æ—Ä–æ—à–∏–µ
  });
  chartInstances.push(new Chart(q('#chart_canvas_7').getContext('2d'), { type:'radar', data:{labels, datasets:[{label:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ 4-5 –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º', data:radarData, backgroundColor:'rgba(255,165,0,0.2)', borderColor:'rgba(255,165,0,0.9)'}]}, options:{responsive:true, plugins:{legend:{display:true}}} }));

  // 8. Pie chart: –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–ª–∏—á–Ω–∏–∫–æ–≤/—Ö–æ—Ä–æ—à–∏—Å—Ç–æ–≤/—Ç—Ä–æ–µ—á–Ω–∏–∫–æ–≤/–¥–≤–æ–µ—á–Ω–∏–∫–æ–≤
  const pieCounts = {'5':0,'4':0,'3':0,'2':0};
  data.forEach(r=>subjects.forEach(s=>{ if(r[s]!==undefined && r[s]!==''){ pieCounts[r[s]]++; }}));
  chartInstances.push(new Chart(q('#chart_canvas_8').getContext('2d'), { type:'pie', data:{labels:['–û—Ç–ª–∏—á–Ω–∏–∫–∏','–•–æ—Ä–æ—à–∏—Å—Ç—ã','–¢—Ä–æ–µ—á–Ω–∏–∫–∏','–î–≤–æ–µ—á–Ω–∏–∫–∏'], datasets:[{data: ['5','4','3','2'].map(g=>pieCounts[g]), backgroundColor:['#4caf50','#2196f3','#ff9800','#f44336']}]}, options:{responsive:true, plugins:{legend:{position:'right'}}} }));
}

/* ========== –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–û–í ========== */
const fileInput = q('#file_input');
const chooseBtn = q('#choose_file');
const dropArea = q('#drop_area');
const fileNameEl = q('#file_name');

chooseBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{ if(e.target.files.length) await handleFile(e.target.files[0]); });

// drag & drop
dropArea.addEventListener('dragover', (e)=>{ e.preventDefault(); dropArea.style.border = '1px dashed rgba(166,75,255,0.6)'; });
dropArea.addEventListener('dragleave', ()=>{ dropArea.style.border = 'none'; });
dropArea.addEventListener('drop', async (e)=>{ e.preventDefault(); dropArea.style.border = 'none'; if(e.dataTransfer.files.length) await handleFile(e.dataTransfer.files[0]); });

async function handleFile(file){
  fileNameEl.textContent = `–§–∞–π–ª: ${file.name} ‚Äî —Ä–∞–∑–º–µ—Ä ${Math.round(file.size/1024)} –ö–ë`;
  const name = file.name.toLowerCase();
  if(name.endsWith('.csv') || name.endsWith('.txt')){
    const text = await file.text(); // browser handles encoding; ensure BOM removed in parser
    const parsed = parseCSV(text, ',');
    // normalize to our format
    data = parsed.map(r => {
      const obj = {Group: r.Group||r.Class||'', LastName: r.LastName||'', FirstName: r.FirstName||'', Patronymic: r.Patronymic||''};
      Object.keys(r).forEach(k => {
        if(!['Group','Class','LastName','FirstName','Patronymic'].includes(k) && k){
          obj[k] = r[k];
        }
      });
      return obj;
    });
    saveToLocal(); refreshAll();
  } else if(name.endsWith('.xlsx') || name.endsWith('.xls')){
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval: ''}); // defval ensures empty cells are ''
    data = json.map(r => {
      const obj = {Group: r.Group||r.Class||'', LastName: r.LastName||r.FamilyName||r.–§–∞–º–∏–ª–∏—è||'', FirstName: r.FirstName||r.GivenName||r.–ò–º—è||'', Patronymic: r.Patronymic||r.–û—Ç—á–µ—Å—Ç–≤–æ||''};
      Object.keys(r).forEach(k => {
        if(!['Group','Class','LastName','FirstName','Patronymic','FamilyName','GivenName','–§–∞–º–∏–ª–∏—è','–ò–º—è','–û—Ç—á–µ—Å—Ç–≤–æ'].includes(k) && k){
          obj[k] = r[k];
        }
      });
      return obj;
    });
    saveToLocal(); refreshAll();
  } else {
    alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .csv, .txt –∏–ª–∏ .xlsx');
  }
}

/* –û—á–∏—Å—Ç–∫–∞ */
q('#clear_data').addEventListener('click', ()=>{ if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) return; data=[]; saveToLocal(); refreshAll(); q('#file_name').textContent=''; });

/* ========== –†–ï–§–†–ï–® –í–°–ï–• –í–ò–î–û–í –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ========== */
function refreshAll(){
  renderTable('table_preview');
  renderEditSubjects();
  renderEditTable();
  refreshSelectors();
  renderStatsTable();
  renderCharts();
}

/* ========== TAB SWITCHING ========== */
qa('.menu button').forEach(btn => btn.addEventListener('click', (e)=>{
  qa('.menu button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  activateTab(btn.dataset.tab);
}));

function activateTab(id){
  qa('main section, main > section, main > div, main > section').forEach(s=>{ /* noop for safety */ });
  // hide all top-level sections in main: select by id list
  ['upload','editor','stats_table','stats_chart','help','about'].forEach(name=>{
    const el = document.getElementById(name);
    if(el) el.style.display = (name === id ? 'block' : 'none');
  });
  // ensure charts re-render if opening chart tab
  if(id === 'stats_chart') renderCharts();
}

/* ========== SEARCH FILTER (editor) ========== */
q('#search_last')?.addEventListener('input', (e)=>{
  const qv = e.target.value.trim().toLowerCase();
  if(!qv){ renderEditTable(); return; }
  const filtered = data.map((r,i)=>({...r,__i:i})).filter(r => (r.LastName||'').toLowerCase().includes(qv));
  const wrap = q('#edit_table_wrapper');
  if(!filtered.length){ wrap.innerHTML = '<div class="small">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  const table = document.createElement('table'); const thead = document.createElement('thead'); const htr = document.createElement('tr');
  ['#','–ì—Ä—É–ø–ø–∞','–§–∞–º–∏–ª–∏—è','–ò–º—è','–û—Ç—á–µ—Å—Ç–≤–æ', ...subjects,'–î–µ–π—Å—Ç–≤–∏—è'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; htr.appendChild(th);});
  thead.appendChild(htr); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  filtered.forEach(row=>{
    const tr = document.createElement('tr');
    const cols = [row.__i+1,row.Group,row.LastName,row.FirstName,row.Patronymic, ...subjects.map(s=> row[s]===undefined? '': row[s])];
    cols.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
    const tdAct = document.createElement('td'); const selBtn=document.createElement('button'); selBtn.className='ghost'; selBtn.textContent='–í—ã–±—Ä–∞—Ç—å'; selBtn.addEventListener('click', ()=> selectRow(row.__i));
    tdAct.appendChild(selBtn); tr.appendChild(tdAct); tbody.appendChild(tr);
  });
  table.appendChild(tbody); wrap.innerHTML=''; wrap.appendChild(table);
});

/* ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  // UI hooks
  q('#add_student').addEventListener('click', addStudent);
  q('#update_student').addEventListener('click', updateStudent);
  q('#delete_student').addEventListener('click', deleteStudent);
  q('#save_csv').addEventListener('click', saveCSV);
  q('#export_xlsx').addEventListener('click', exportXLSX);
  q('#recalc_stats').addEventListener('click', renderStatsTable);

  // try to load saved data
  const loaded = loadFromLocal();
  if(!loaded) data = []; // start empty
  renderEditSubjects();
  refreshAll();

  // ensure upload is visible initially
  activateTab('upload');
});

/* ========== –ö–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞ ========== */
</script>

</body>
</html>
